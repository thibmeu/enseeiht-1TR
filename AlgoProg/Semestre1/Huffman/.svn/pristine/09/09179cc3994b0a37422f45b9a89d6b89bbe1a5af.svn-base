#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "uncompress.h"

int main(int argc, char** argv)
{
	FILE* input = fopen(argv[1], "rb");
	size_t sizeText;
	char sizeTree;
	Value* caracs;
	
	read_forhead(input, &sizeText, &sizeTree, &caracs);
	printf("tt: %lu, ta: %i\n", sizeText, sizeTree);
	for (int i = 0; i < sizeTree; i++)
		printf("%i\n", caracs[i]);
	size_t nbLeaf = 0;
	Tree tree;
	init_Tree(&tree);
	Byte byte;
	fscanf(input, "%c", &byte);
	byte = byte << 2;
	size_t sizeByte = 6;
	print_Byte(byte, sizeByte);
	reconstruct_Tree(input, tree, &byte, &sizeByte, (size_t)sizeTree, &nbLeaf, caracs);
	print_Tree(tree);
	
	Binary tableCorresp[CHAR_MAX];
	for(int i=0; i< CHAR_MAX; i++)
		init_Binary(tableCorresp+i);
	
	construct_table_corresp(tree, tableCorresp, caracs, sizeTree, 0, 0);
	
	size_t sizeNameInput = strlen(argv[1]);
	char* name_output = malloc(sizeNameInput*sizeof(char));
	
	strncat(name_output, name_output, sizeNameInput - 3);
	FILE* output = fopen(name_output, "w");
	
	write_body_uncompress(input, output, tableCorresp, sizeTree , byte, sizeByte);
	
	destruct_Tree(&tree);
	free(caracs);
	fclose(input);
	return 0;
}
